<!DOCTYPE html>
<html>
   <head>
      <title>Cards</title>
      <link rel="stylesheet" type="text/css" href="CardGame.css">
   </head>
   <body class = "head" onload="getCards()">
    <div id="solution">0</div>
    <div id="field">
       <div id="cardTemp" class="card" style="left: 0px; width: 315px; height: 440px; top: 0px;"></div>
    </div>
 
    <div id="sidebox">
      <input id ="EndTurn" type="submit" value="Run" onclick="run()">
      <p id="output">Code will be output here. </p>
    </div>

 
     <input id ="resetField" type="submit" value="Reset" onclick="removeFieldCards()">



    <div id="cards_in_hand"></div>
     
    <div id="footer"> <a href = "https://www.refinery.io/" target="_blank">Powered by Refinery.io</a></div>
   </body>
   <script>
url = "https://sgp5y79yog.execute-api.us-west-2.amazonaws.com/refinery/programminglanguage"
cardStack = []

console.log("Total Width: " + screen.width);
console.log("Total Height: " + screen.height);
cardHeight = 20.3;
cardWidth = 8.2;
var solution = 0;

async function getSolutions(){
  data = await fetchPost('',"https://sgp5y79yog.execute-api.us-west-2.amazonaws.com/refinery/solutions");
  console.log(data);

  c1 = data[0];
  c2= data[3];
  v = data[1];
  op = data [2];

  solution = c1;
  document.getElementById("solution").innerHTML = solution;
}

async function getCards(){
  getSolutions();
  //VAR IF THEN ELSE gets
  data = await fetchPost('p2 p3 p4 plus minus mul POW LP RP',"https://sgp5y79yog.execute-api.us-west-2.amazonaws.com/refinery/card");
  //console.log(data);
  topPosition = 56;
  leftPosition = 2.5;

  for (i = 0; i < data.length; i++){
    var wrapper= document.createElement('div');
    wrapper.innerHTML= trim(data[i]);
    var div= wrapper.firstChild;
    document.getElementById("cards_in_hand").appendChild(div);

    leftPosition = leftPosition + cardWidth+.5;
    if (i==0){
      leftPosition = 2.5;
    }

    div.style.left = leftPosition+"%";
    div.style.width = cardWidth+"%";
    div.style.height = cardHeight+"%";
    div.style.top = topPosition+"%";
  }

  //document.getElementById('card').innerHTML = data)
}


async function run(){
  var cards = document.getElementById('field').getElementsByClassName('cardValue');
  var i = cards.length
  var data = ""
  for(x=0; x<i; x++){
      if (cards[x].value == undefined){
        data = data + trim(cards[x].innerHTML) + " ";
      }
      else{
        data = data + trim(cards[x].value) + " ";
      }
  }
  data = await fetchPost([data], url)

  if (data == solution){
    document.getElementById('output').innerHTML = data+" is correct!";
    removeFieldCards();
    getSolutions();
  }
  else{
    document.getElementById('output').innerHTML = data;
  }
}

function removeFieldCards(){
  e = document.getElementById('field');
    child = e.lastElementChild;  
    while (child) { 
      e.removeChild(child); 
      child = e.lastElementChild; 
    }
}

function trim(s){ 
  return ( s || '' ).replace( /^\s+|\s+$/g, '' ); 
}


function fetchPost(data, url) {
  return fetch(url, {  
    method: "POST",  
    cors: true,
    body: JSON.stringify(
      data
    )
  }).then(response => response.json());   
}

function getInt(text){
  var matches = text.match(/(\d+)/);
  if (matches){
    return (parseInt(matches[0], 10));
  }
}

function addNewCard(cardID, len, t){
  console.log(cardID +' Clicked');
  div = document.getElementById(cardID);
  //console.log(div);
  newDiv = div.cloneNode(true);
  newDiv.setAttribute("id", "card"+len);

  newDiv.style.left = (170*len)+"px";
  newDiv.style.width = "157px";
  newDiv.style.height = "220px";
  newDiv.style.top = t+"px";

  document.getElementById('field').appendChild(newDiv);
}




isDown = false;
firstPass = true;


document.addEventListener('mousedown', function(e) {
  var cardsInPlay = document.getElementById("field").getElementsByClassName('card');
  len = cardsInPlay.length;
  var cards = document.getElementById("cards_in_hand").getElementsByClassName('card');
  isDown = true;
  for (i=0;i<cards.length;i++){
    card=cards[i];
    left = card.offsetLeft;
    right = left + card.offsetWidth;
    cTop = card.offsetTop;
    bot = cTop + card.offsetHeight;
    console.log(card.style.width)
    if((e.clientX >= left && e.clientX<right)&&(e.clientY >= cTop && e.clientY<bot)){
      console.log("card clicked");
      cardID = cards[i].id;
      if (firstPass){
        firstPass=false;
        var elem = document.getElementById('cardTemp');
        elem.parentNode.removeChild(elem);
        len--;
      }
      addNewCard(cardID, len, 0);
    }
  }
  //console.log(e.clientX, e.clientY);
}, true);

document.addEventListener('mouseup', function() {
    isDown = false;
}, true);

document.addEventListener('mousemove', function(event) {
        
    event.preventDefault();
    if (isDown) {
        mousePosition = {
    
            x : event.clientX,
            y : event.clientY
        };
        //console.log(mousePosition)
    }
    
}, true);
   </script>
</html>



